---
import Icon from './Icon.astro';

interface Props {
  isAdmin?: boolean;
}

const { isAdmin = false } = Astro.props;
---

<nav class="mx-auto mt-2 sm:mt-3 max-w-7xl flex items-center justify-between rounded-xl border border-[#404040]/50 bg-[#1c1c1c] dark:border-[#404040]/50 dark:bg-[#1c1c1c] border-[#a3a3a3]/50 bg-white px-3 sm:px-4 md:px-6 py-2 sm:py-3">
  <!-- Logo -->
  <a href="/" class="flex items-center gap-1.5 sm:gap-2">
    <!-- Logo Container -->
    <span id="navbar-logo-container" class="shrink-0" style="opacity: 0;">
      <svg width="20" height="20" class="sm:w-6 sm:h-6 monitor-icon default-logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="--monitor-stroke: #24292f;">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.5 12h2l2-6 3 18 2.5-12h2" style="stroke: var(--monitor-stroke);">
          <animate attributeName="opacity" values="0.5;1;0.5" dur="2s" repeatCount="indefinite"/>
        </path>
        <path stroke-linecap="round" stroke-width="1.5" d="M3 12h2M19 12h2" style="stroke: var(--monitor-stroke);">
          <animate attributeName="opacity" values="0.3;0.8;0.3" dur="2s" repeatCount="indefinite"/>
        </path>
        <path stroke-linecap="round" stroke-width="1.5" opacity="0.5" d="M1 12h1M22 12h1" style="stroke: var(--monitor-stroke);">
          <animate attributeName="opacity" values="0.2;0.5;0.2" dur="2s" repeatCount="indefinite"/>
        </path>
        <circle cx="12" cy="12" r="9" stroke-width="1.5" opacity="0.2" style="stroke: var(--monitor-stroke);">
          <animate attributeName="opacity" values="0.1;0.3;0.1" dur="2s" repeatCount="indefinite"/>
        </circle>
        <circle cx="12" cy="12" r="5" stroke-width="1.5" opacity="0.4" style="stroke: var(--monitor-stroke);">
          <animate attributeName="opacity" values="0.2;0.6;0.2" dur="2s" repeatCount="indefinite"/>
        </circle>
      </svg>
    </span>
    <!-- Text Container -->
    <span id="navbar-text" class="text-lg sm:text-xl md:text-2xl font-bold tracking-tight text-[#262626] dark:text-white" style="opacity: 0;">Pulse</span>
  </a>

  <!-- Right Side Icons -->
  <div id="navbar-icons-container" class="flex items-center gap-0.5 sm:gap-1" style="opacity: 0;">
    <button id="language-btn" class="rounded-lg p-1.5 sm:p-2 text-[#a3a3a3] dark:text-[#a3a3a3] text-[#525252] transition-all duration-200 hover:bg-[#282828] dark:hover:bg-[#282828] hover:bg-[#f5f5f5] hover:text-[#262626] dark:hover:text-[#e5e5e5] active:scale-90" aria-label="language" title="切换语言">
      <Icon name="languages" size={16} class="w-4 h-4 sm:w-[18px] sm:h-[18px] transition-transform duration-200" />
      </button>
    <button id="theme-btn" class="rounded-lg p-1.5 sm:p-2 text-[#a3a3a3] dark:text-[#a3a3a3] text-[#525252] transition-all duration-200 hover:bg-[#282828] dark:hover:bg-[#282828] hover:bg-[#f5f5f5] hover:text-[#262626] dark:hover:text-[#e5e5e5] active:scale-90" aria-label="theme" title="切换主题">
      <Icon id="theme-icon-moon" name="moon" size={16} class="w-4 h-4 sm:w-[18px] sm:h-[18px] hidden dark:block transition-all duration-300" />
      <Icon id="theme-icon-sun" name="sun" size={16} class="w-4 h-4 sm:w-[18px] sm:h-[18px] block dark:hidden transition-all duration-300" />
      </button>
    {isAdmin ? (
      <a href="/" class="rounded-lg p-1.5 sm:p-2 text-[#a3a3a3] dark:text-[#a3a3a3] text-[#525252] transition-all duration-200 hover:bg-[#282828] dark:hover:bg-[#282828] hover:bg-[#f5f5f5] hover:text-[#262626] dark:hover:text-[#e5e5e5] active:scale-90" aria-label="home">
        <Icon name="home" size={16} class="w-4 h-4 sm:w-[18px] sm:h-[18px] transition-transform duration-200" />
      </a>
    ) : (
      <a href="/admin" class="rounded-lg p-1.5 sm:p-2 text-[#a3a3a3] dark:text-[#a3a3a3] text-[#525252] transition-all duration-200 hover:bg-[#282828] dark:hover:bg-[#282828] hover:bg-[#f5f5f5] hover:text-[#262626] dark:hover:text-[#e5e5e5] active:scale-90" aria-label="admin">
      <Icon name="user" size={16} class="w-4 h-4 sm:w-[18px] sm:h-[18px] transition-transform duration-200" />
    </a>
    )}
    </div>
  </nav>

<script>
  (function() {
    // Language management
    function getSystemLanguage() {
      return navigator.language || (navigator.languages && navigator.languages[0]) || 'en';
    }

    function getStoredLanguage() {
      return localStorage.getItem('preferred-language');
    }

    function setLanguage(lang) {
      localStorage.setItem('preferred-language', lang);
      document.documentElement.lang = lang;
      // Trigger language change event for other components
      window.dispatchEvent(new CustomEvent('languagechange', { detail: { language: lang } }));
    }

    function getCurrentLanguage() {
      const stored = getStoredLanguage();
      if (stored) {
        return stored;
      }
      // Default to system language
      const sysLang = getSystemLanguage();
      // Convert system language to 'zh' or 'en'
      if (sysLang.toLowerCase().startsWith('zh')) {
        return 'zh';
      }
      return 'en';
    }

    function toggleLanguage() {
      const current = getCurrentLanguage();
      const newLang = current === 'zh' ? 'en' : 'zh';
      setLanguage(newLang);
      updateLanguageButton();
    }

    function updateLanguageButton() {
      const btn = document.getElementById('language-btn');
      if (btn) {
        // Update tooltip/aria-label based on current language
        const current = getCurrentLanguage();
        btn.setAttribute('aria-label', current === 'zh' ? 'Switch to English' : '切换到中文');
        btn.setAttribute('title', current === 'zh' ? 'Switch to English' : '切换到中文');
      }
    }

    // Theme management
    function getSystemTheme() {
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        return 'dark';
      }
      return 'light';
    }

    function getStoredTheme() {
      return localStorage.getItem('preferred-theme');
    }

    function setTheme(theme) {
      localStorage.setItem('preferred-theme', theme);
      applyTheme(theme);
    }

    function getCurrentTheme() {
      const stored = getStoredTheme();
      if (stored === 'dark' || stored === 'light') {
        return stored;
      }
      // Default to system theme
      return getSystemTheme();
    }

    function toggleTheme() {
      const current = getCurrentTheme();
      const newTheme = current === 'dark' ? 'light' : 'dark';
      setTheme(newTheme);
    }

    function applyTheme(theme) {
      const html = document.documentElement;
      const body = document.body;
      if (theme === 'dark') {
        html.classList.add('dark');
        html.classList.remove('light');
        body.classList.add('dark');
        body.classList.remove('light');
      } else {
        html.classList.add('light');
        html.classList.remove('dark');
        body.classList.add('light');
        body.classList.remove('dark');
      }
      updateThemeIcon(theme);
      // Trigger theme change event for other components
      window.dispatchEvent(new CustomEvent('themechange', { detail: { theme: theme } }));
    }

    function updateThemeIcon(theme) {
      const moonIcon = document.getElementById('theme-icon-moon');
      const sunIcon = document.getElementById('theme-icon-sun');
      if (moonIcon && sunIcon) {
        // Add rotation animation on switch
        const showIcon = theme === 'dark' ? moonIcon : sunIcon;
        const hideIcon = theme === 'dark' ? sunIcon : moonIcon;
        
        // Animate out
        hideIcon.style.transform = 'rotate(-90deg) scale(0.5)';
        hideIcon.style.opacity = '0';
        
        setTimeout(() => {
          hideIcon.classList.remove('block');
          hideIcon.classList.add('hidden');
          hideIcon.style.transform = '';
          hideIcon.style.opacity = '';
          
          // Animate in
          showIcon.style.transform = 'rotate(90deg) scale(0.5)';
          showIcon.style.opacity = '0';
          showIcon.classList.remove('hidden');
          showIcon.classList.add('block');
          
          // Trigger reflow
          showIcon.offsetHeight;
          
          showIcon.style.transform = 'rotate(0deg) scale(1)';
          showIcon.style.opacity = '1';
        }, 150);
      }
      
      // Update monitor icon stroke color based on theme
      const monitorIcon = document.querySelector('.monitor-icon');
      if (monitorIcon) {
        if (theme === 'dark') {
          monitorIcon.style.setProperty('--monitor-stroke', '#c9d1d9');
        } else {
          monitorIcon.style.setProperty('--monitor-stroke', '#24292f');
        }
      }
    }

    // System theme listener removed - we use fixed defaults (English and Dark)

    // Apply navbar configuration and show content with smooth fade-in animation
    function applyNavbarConfig(config) {
      const navbarText = document.getElementById('navbar-text');
      const logoContainer = document.getElementById('navbar-logo-container');
      const iconsContainer = document.getElementById('navbar-icons-container');
      
      // Update navbar text
      if (navbarText) {
        if (config && config.text) {
          navbarText.textContent = config.text;
        }
      }
      
      // Update navbar logo
      if (logoContainer) {
        if (config && config.logo) {
          // Check if logo is a URL or SVG code
          if (config.logo.startsWith('http://') || config.logo.startsWith('https://') || config.logo.startsWith('//')) {
            // It's a URL - use img tag
            logoContainer.innerHTML = `<img src="${config.logo}" alt="Logo" class="w-5 h-5 sm:w-6 sm:h-6" style="object-fit: contain;" />`;
          } else if (config.logo.trim().startsWith('<svg')) {
            // It's SVG code - insert directly
            logoContainer.innerHTML = config.logo;
            // Ensure SVG has proper size classes
            const svg = logoContainer.querySelector('svg');
            if (svg) {
              svg.classList.add('w-5', 'h-5', 'sm:w-6', 'sm:h-6');
              if (!svg.hasAttribute('width')) svg.setAttribute('width', '20');
              if (!svg.hasAttribute('height')) svg.setAttribute('height', '20');
            }
          }
        } else {
          // Reset to default logo if config.logo is empty
          const defaultLogo = logoContainer.querySelector('.default-logo');
          if (!defaultLogo) {
            // Restore default SVG if it was replaced
            logoContainer.innerHTML = `<svg width="20" height="20" class="sm:w-6 sm:h-6 monitor-icon default-logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="--monitor-stroke: #24292f;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.5 12h2l2-6 3 18 2.5-12h2" style="stroke: var(--monitor-stroke);"><animate attributeName="opacity" values="0.5;1;0.5" dur="2s" repeatCount="indefinite"/></path><path stroke-linecap="round" stroke-width="1.5" d="M3 12h2M19 12h2" style="stroke: var(--monitor-stroke);"><animate attributeName="opacity" values="0.3;0.8;0.3" dur="2s" repeatCount="indefinite"/></path><path stroke-linecap="round" stroke-width="1.5" opacity="0.5" d="M1 12h1M22 12h1" style="stroke: var(--monitor-stroke);"><animate attributeName="opacity" values="0.2;0.5;0.2" dur="2s" repeatCount="indefinite"/></path><circle cx="12" cy="12" r="9" stroke-width="1.5" opacity="0.2" style="stroke: var(--monitor-stroke);"><animate attributeName="opacity" values="0.1;0.3;0.1" dur="2s" repeatCount="indefinite"/></circle><circle cx="12" cy="12" r="5" stroke-width="1.5" opacity="0.4" style="stroke: var(--monitor-stroke);"><animate attributeName="opacity" values="0.2;0.6;0.2" dur="2s" repeatCount="indefinite"/></circle></svg>`;
          }
        }
      }
      
      // Update monitor icon stroke color based on current theme
      const currentTheme = getCurrentTheme();
      const monitorIcon = logoContainer?.querySelector('.monitor-icon');
      if (monitorIcon) {
        if (currentTheme === 'dark') {
          monitorIcon.style.setProperty('--monitor-stroke', '#c9d1d9');
        } else {
          monitorIcon.style.setProperty('--monitor-stroke', '#24292f');
        }
      }
      
      // Show all elements with smooth staggered fade-in animation
      // Use requestAnimationFrame to ensure smooth animation trigger
      requestAnimationFrame(() => {
        if (logoContainer) {
          logoContainer.classList.add('animate-stagger-in');
          logoContainer.style.animationDelay = '0ms';
        }
        
        if (navbarText) {
          navbarText.classList.add('animate-stagger-in');
          navbarText.style.animationDelay = '50ms';
        }
        
        if (iconsContainer) {
          iconsContainer.classList.add('animate-stagger-in');
          iconsContainer.style.animationDelay = '100ms';
        }
      });
    }

    // Load navbar configuration from backend
    async function loadNavbarConfig() {
      // Check if config was preloaded
      if (window.__navbarConfig) {
        applyNavbarConfig(window.__navbarConfig);
        return;
      }
      
      try {
        const apiBase = window.location.origin;
        const res = await fetch(`${apiBase}/api/navbar/config`);
        if (res.ok) {
          const config = await res.json();
          applyNavbarConfig(config);
        } else {
          // If request failed, show defaults with animation
          applyNavbarConfig(null);
        }
      } catch (err) {
        // Config load failed silently - use defaults and show them with animation
        applyNavbarConfig(null);
      }
    }

    // Initialize on page load
    function init() {
      // Language and theme are already set in head script, just sync UI
      const currentLang = getCurrentLanguage();
      // Only update if different (to avoid unnecessary updates)
      if (document.documentElement.lang !== currentLang) {
        setLanguage(currentLang);
      }
      updateLanguageButton();

      // Theme is already applied, just sync icon
      const currentTheme = getCurrentTheme();
      // Only update if different (to avoid unnecessary updates)
      const htmlHasDark = document.documentElement.classList.contains('dark');
      const shouldBeDark = currentTheme === 'dark';
      if (htmlHasDark !== shouldBeDark) {
        applyTheme(currentTheme);
      } else {
        // Just update the icon without changing theme
        updateThemeIcon(currentTheme);
      }
      
      // Initialize monitor icon color
      const monitorIcon = document.querySelector('.monitor-icon');
      if (monitorIcon) {
        if (currentTheme === 'dark') {
          monitorIcon.style.setProperty('--monitor-stroke', '#c9d1d9');
        } else {
          monitorIcon.style.setProperty('--monitor-stroke', '#24292f');
        }
      }

      // Load navbar configuration (or use preloaded config)
      loadNavbarConfig();
      
      // Listen for preloaded config event
      window.addEventListener('navbarconfigready', (e) => {
        applyNavbarConfig(e.detail);
      });

      // Setup event listeners
      const languageBtn = document.getElementById('language-btn');
      const themeBtn = document.getElementById('theme-btn');

      if (languageBtn) {
        languageBtn.addEventListener('click', toggleLanguage);
      }

      if (themeBtn) {
        themeBtn.addEventListener('click', toggleTheme);
      }

      // System theme listener removed - we use fixed defaults
    }

    // Run initialization
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>

