---
// Login form component for admin authentication
---

<div class="min-h-screen flex items-center justify-center bg-white dark:bg-[#151515] px-3 sm:px-4">
  <div class="w-full max-w-md">
    <div class="bg-white dark:bg-[#1a1a1a] rounded-lg border border-[#a3a3a3]/50 dark:border-[#404040]/50 p-4 sm:p-6 md:p-8 shadow-lg animate-login-card">
      <!-- Logo/Title -->
      <div class="text-center mb-6 sm:mb-8 animate-form-field" style="animation-delay: 0.1s;">
        <h1 class="text-xl sm:text-2xl font-bold text-[#0a0a0a] dark:text-[#f5f5f5] mb-2" data-translate-login="title">Admin Login</h1>
        <p class="text-xs sm:text-sm text-[#525252] dark:text-[#a3a3a3]" data-translate-login="subtitle">Enter your password to access the admin panel</p>
      </div>

      <!-- Error message -->
      <div id="login-error" class="hidden mb-4 p-3 rounded-lg bg-red-500/10 border border-red-500/50 animate-scale-in">
        <p class="text-sm text-red-500" id="login-error-text"></p>
      </div>

      <!-- Success message (for password setup) -->
      <div id="login-success" class="hidden mb-4 p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/50 animate-scale-in">
        <p class="text-sm text-emerald-500" id="login-success-text"></p>
      </div>

      <!-- Login Form -->
      <form id="login-form" class="space-y-4">
        <div class="animate-form-field" style="animation-delay: 0.2s;">
          <label for="password" class="block text-sm font-medium text-[#525252] dark:text-[#a3a3a3] mb-2" data-translate-login="password">Password</label>
          <input
            type="password"
            id="password"
            name="password"
            required
            autocomplete="current-password"
            class="w-full px-4 py-2 rounded-lg border border-[#a3a3a3]/50 dark:border-[#404040]/50 bg-white dark:bg-[#151515] text-[#0a0a0a] dark:text-[#f5f5f5] focus:outline-none focus:ring-2 focus:ring-[#404040] dark:focus:ring-[#404040] focus:border-transparent transition-all duration-200 placeholder:text-[#737373] dark:placeholder:text-[#737373]"
            placeholder="Enter password"
          />
        </div>

        <div id="confirm-password-field" class="hidden animate-form-field" style="animation-delay: 0.25s;">
          <label for="confirm-password" class="block text-sm font-medium text-[#525252] dark:text-[#a3a3a3] mb-2" data-translate-login="confirmPassword">Confirm Password</label>
          <input
            type="password"
            id="confirm-password"
            name="confirm-password"
            autocomplete="new-password"
            class="w-full px-4 py-2 rounded-lg border border-[#a3a3a3]/50 dark:border-[#404040]/50 bg-white dark:bg-[#151515] text-[#0a0a0a] dark:text-[#f5f5f5] focus:outline-none focus:ring-2 focus:ring-[#404040] dark:focus:ring-[#404040] focus:border-transparent transition-all duration-200 placeholder:text-[#737373] dark:placeholder:text-[#737373]"
            placeholder="Confirm password"
          />
        </div>

        <div class="animate-form-field" style="animation-delay: 0.3s;">
        <button
          type="submit"
          id="login-submit"
            class="w-full py-2 px-4 rounded-lg bg-[#404040] hover:bg-[#525252] text-white font-medium transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-[#404040] focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-[#151515] btn-press"
          data-translate-login="submit"
        >
          Login
        </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Get API base URL - same logic as other components
  function getApiBase() {
    const root = document.documentElement;
    if (root?.dataset?.apiBase && root.dataset.apiBase.trim() !== '') {
      return root.dataset.apiBase.trim();
    }
    // Use current origin (works with nginx reverse proxy)
    return window.location.origin;
  }
  
  const apiBase = getApiBase();
  
  // Translations
  const translations = {
    en: {
      title: 'Admin Login',
      subtitle: 'Enter your password to access the admin panel',
      password: 'Password',
      confirmPassword: 'Confirm Password',
      submit: 'Login',
      setupPassword: 'Setup Password',
      setupSubtitle: 'Set up your admin password (first time only)',
      error: 'Error',
      invalidPassword: 'Invalid password',
      passwordMismatch: 'Passwords do not match',
      passwordTooShort: 'Password must be at least 6 characters',
      setupSuccess: 'Password set successfully! Redirecting...',
      loginSuccess: 'Login successful! Redirecting...'
    },
    zh: {
      title: '管理员登录',
      subtitle: '输入密码以访问管理面板',
      password: '密码',
      confirmPassword: '确认密码',
      submit: '登录',
      setupPassword: '设置密码',
      setupSubtitle: '设置您的管理员密码（仅首次）',
      error: '错误',
      invalidPassword: '密码错误',
      passwordMismatch: '密码不匹配',
      passwordTooShort: '密码至少需要6个字符',
      setupSuccess: '密码设置成功！正在跳转...',
      loginSuccess: '登录成功！正在跳转...'
    }
  };

  function getSystemLanguage() {
    const sysLang = navigator.language || (navigator.languages && navigator.languages[0]) || 'en';
    // Check if system language is Chinese (zh, zh-CN, zh-TW, etc.)
    if (sysLang.toLowerCase().startsWith('zh')) {
      return 'zh';
    }
    return 'en';
  }

  function getCurrentLanguage() {
    const stored = localStorage.getItem('preferred-language');
    if (stored === 'zh' || stored === 'en') {
      return stored;
    }
    // Default to system language
    return getSystemLanguage();
  }

  function updateTranslations() {
    const lang = getCurrentLanguage();
    const t = translations[lang];
    
    document.querySelectorAll('[data-translate-login]').forEach(el => {
      const key = el.getAttribute('data-translate-login');
      if (key && t[key]) {
        el.textContent = t[key];
      }
    });
  }

  // Check if password is already set
  async function checkPasswordStatus() {
    try {
      const res = await fetch(`${apiBase}/api/auth/status`);
      if (res.ok) {
        const data = await res.json();
        return data.set;
      }
    } catch (err) {
      // Status check failed silently
    }
    return false;
  }

  // Setup password (first time)
  async function setupPassword(password) {
    try {
      const res = await fetch(`${apiBase}/api/auth/setup`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });
      
      if (!res.ok) {
        const errorText = await res.text();
        return { success: false, error: errorText || 'Failed to setup password' };
      }
      
      return { success: true };
    } catch (err) {
      return { success: false, error: err.message || 'Network error' };
    }
  }

  // Login with password
  async function login(password) {
    try {
      const res = await fetch(`${apiBase}/api/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });
      
      if (res.ok) {
        const data = await res.json();
        if (data.success) {
          // Store auth token
          localStorage.setItem('admin_auth_token', data.token);
          return true;
        }
      }
      return false;
    } catch (err) {
      return false;
    }
  }

  function showError(message) {
    const errorDiv = document.getElementById('login-error');
    const errorText = document.getElementById('login-error-text');
    errorText.textContent = message;
    errorDiv.classList.remove('hidden');
    setTimeout(() => {
      errorDiv.classList.add('hidden');
    }, 5000);
  }

  function showSuccess(message) {
    const successDiv = document.getElementById('login-success');
    const successText = document.getElementById('login-success-text');
    successText.textContent = message;
    successDiv.classList.remove('hidden');
  }

  // Theme management - just apply stored theme, no toggle button
  function getSystemTheme() {
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      return 'dark';
    }
    return 'light';
  }

  function getCurrentTheme() {
    const stored = localStorage.getItem('preferred-theme');
    if (stored === 'dark' || stored === 'light') {
      return stored;
    }
    // Default to system theme
    return getSystemTheme();
  }

  function applyTheme(theme) {
    const html = document.documentElement;
    const body = document.body;
    if (theme === 'dark') {
      html.classList.add('dark');
      html.classList.remove('light');
      body.classList.add('dark');
      body.classList.remove('light');
    } else {
      html.classList.add('light');
      html.classList.remove('dark');
      body.classList.add('light');
      body.classList.remove('dark');
    }
  }

  // Initialize
  (async () => {
    // Initialize theme from localStorage
    const currentTheme = getCurrentTheme();
    applyTheme(currentTheme);
    
    updateTranslations();
    
    // Listen for language changes
    window.addEventListener('languagechange', updateTranslations);
    window.addEventListener('translate', updateTranslations);

    const isPasswordSet = await checkPasswordStatus();
    const form = document.getElementById('login-form');
    const passwordField = document.getElementById('password');
    const confirmPasswordField = document.getElementById('confirm-password-field');
    const confirmPasswordInput = document.getElementById('confirm-password');
    const submitButton = document.getElementById('login-submit');
    const title = document.querySelector('[data-translate-login="title"]');
    const subtitle = document.querySelector('[data-translate-login="subtitle"]');

    if (!isPasswordSet) {
      // First time setup
      const lang = getCurrentLanguage();
      title.textContent = translations[lang].setupPassword;
      subtitle.textContent = translations[lang].setupSubtitle;
      confirmPasswordField.classList.remove('hidden');
      confirmPasswordInput.required = true;
      submitButton.textContent = translations[lang].setupPassword;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const password = passwordField.value.trim();
      const confirmPassword = confirmPasswordInput.value.trim();

      // Validation
      if (password.length < 6) {
        const lang = getCurrentLanguage();
        showError(translations[lang].passwordTooShort);
        return;
      }

      if (!isPasswordSet) {
        // Setup password
        if (password !== confirmPassword) {
          const lang = getCurrentLanguage();
          showError(translations[lang].passwordMismatch);
          return;
        }

        const result = await setupPassword(password);
        if (result && result.success) {
          // After setup, automatically login
          const loginResult = await login(password);
          if (loginResult) {
            // Get redirect target from URL parameter or default to /admin
            const urlParams = new URLSearchParams(window.location.search);
            const redirect = urlParams.get('redirect') || '/admin';
            window.location.href = redirect;
          } else {
            // Setup succeeded but login failed, redirect anyway (shouldn't happen)
            const urlParams = new URLSearchParams(window.location.search);
            const redirect = urlParams.get('redirect') || '/admin';
            window.location.href = redirect;
          }
        } else {
          const lang = getCurrentLanguage();
          const errorMsg = (result && result.error) ? result.error : translations[lang].error;
          showError(errorMsg);
        }
      } else {
        // Login
        const success = await login(password);
        if (success) {
          // Get redirect target from URL parameter or default to /admin
          const urlParams = new URLSearchParams(window.location.search);
          const redirect = urlParams.get('redirect') || '/admin';
          window.location.href = redirect;
        } else {
          const lang = getCurrentLanguage();
          showError(translations[lang].invalidPassword);
        }
      }
    });
  })();
</script>

