---
import '../styles/global.css';
import NavBar from '../components/NavBar.astro';
import SystemTable from '../components/SystemTable.astro';
import Footer from '../components/Footer.astro';

// API base will be auto-detected by client-side script
// Can be overridden by PUBLIC_API_BASE environment variable
const apiBase = import.meta.env.PUBLIC_API_BASE ?? '';
---

<html lang="en" class="dark overflow-x-hidden">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>Pulse Monitor</title>
    <!-- Preload Chart.js for faster TCPing chart rendering -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" as="script" crossorigin="anonymous" />
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js" as="script" crossorigin="anonymous" />
    <!-- Initialize language and theme before page render to prevent FOUC -->
    <script is:inline>
      (function() {
        // Get system language (convert to 'zh' or 'en')
        function getSystemLanguage() {
          const sysLang = navigator.language || (navigator.languages && navigator.languages[0]) || 'en';
          // Check if system language is Chinese (zh, zh-CN, zh-TW, etc.)
          if (sysLang.toLowerCase().startsWith('zh')) {
            return 'zh';
          }
          return 'en';
        }
        
        // Get system theme
        function getSystemTheme() {
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            return 'dark';
          }
          return 'light';
        }
        
        // Get language preference (use system language as default)
        const storedLang = localStorage.getItem('preferred-language');
        const lang = storedLang || getSystemLanguage();
        document.documentElement.lang = lang;
        
        // Get theme preference (use system theme as default)
        const storedTheme = localStorage.getItem('preferred-theme');
        const theme = (storedTheme === 'dark' || storedTheme === 'light') ? storedTheme : getSystemTheme();
        
        // Apply theme immediately to html
        const html = document.documentElement;
        if (theme === 'dark') {
          html.classList.add('dark');
          html.classList.remove('light');
        } else {
          html.classList.add('light');
          html.classList.remove('dark');
        }
        
        // Apply theme to body when it's available
        function applyThemeToBody() {
          const body = document.body;
          if (body) {
            if (theme === 'dark') {
              body.classList.add('dark');
              body.classList.remove('light');
            } else {
              body.classList.add('light');
              body.classList.remove('dark');
            }
          } else {
            // Body not ready yet, try again
            requestAnimationFrame(applyThemeToBody);
          }
        }
        applyThemeToBody();
        
        // Preload navbar config early (non-blocking)
        const apiBase = window.location.origin;
        fetch(`${apiBase}/api/navbar/config`)
          .then(res => res.ok ? res.json() : null)
          .then(config => {
            if (config) {
              // Store config for NavBar component to use
              window.__navbarConfig = config;
              // Dispatch event when config is ready
              window.dispatchEvent(new CustomEvent('navbarconfigready', { detail: config }));
            }
          })
          .catch(() => {
            // Silently fail, NavBar will handle defaults
          });
      })();
    </script>
  </head>
<body class="min-h-screen overflow-x-hidden flex flex-col bg-[#151515] dark:bg-[#151515] bg-white text-[#f5f5f5] dark:text-[#f5f5f5] text-[#151515]">
    <div id="auth-check" class="hidden min-h-screen flex flex-col">
      <div class="px-2 sm:px-4 md:px-6 animate-navbar">
      <NavBar />
      </div>
      <main class="flex-1 px-2 sm:px-4 md:px-6 pt-2 sm:pt-3 pb-4 sm:pb-6 animate-content">
        <SystemTable apiBase={apiBase} />
      </main>
      <Footer />
    </div>
    <div id="login-redirect" class="min-h-screen flex items-center justify-center">
      <div class="text-center animate-page-in">
        <div class="w-8 h-8 border-2 border-[#404040] dark:border-[#404040] border-[#a3a3a3] border-t-transparent dark:border-t-transparent rounded-full animate-spin-smooth mx-auto mb-4"></div>
        <p class="text-sm text-[#a3a3a3] dark:text-[#a3a3a3] text-[#525252]">Checking access...</p>
      </div>
    </div>
  </body>
</html>

<script>
  // Get API base URL
  function getApiBase() {
    const apiBase = import.meta.env.PUBLIC_API_BASE;
    if (apiBase && apiBase.trim() !== '') {
      return apiBase.trim();
    }
    return window.location.origin;
  }
  
  const apiBase = getApiBase();
  
  // Check privacy mode and authentication on page load
  (async () => {
    const authCheck = document.getElementById('auth-check');
    const loginRedirect = document.getElementById('login-redirect');
    
    // Get token from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const shareToken = urlParams.get('token');
    
    // Check privacy config
    try {
      const privacyRes = await fetch(`${apiBase}/api/privacy/config`);
      if (privacyRes.ok) {
        const privacyConfig = await privacyRes.json();
        
        // If privacy is not enabled, allow access
        if (!privacyConfig.enabled) {
          authCheck.classList.remove('hidden');
          loginRedirect.classList.add('hidden');
          return;
        }
        
        // Privacy is enabled, check authentication
        // If share token is provided, verify it
        if (shareToken) {
          const verifyRes = await fetch(`${apiBase}/api/privacy/verify-token`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: shareToken }),
          });
          
          if (verifyRes.ok) {
            const verifyData = await verifyRes.json();
            if (verifyData.valid) {
              // Token is valid, allow access
              authCheck.classList.remove('hidden');
              loginRedirect.classList.add('hidden');
              return;
            }
          }
        }
        
        // Check if user has admin auth token
        const adminToken = localStorage.getItem('admin_auth_token');
        if (adminToken) {
          // Verify admin token
          try {
            const verifyRes = await fetch(`${apiBase}/api/auth/verify`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token: adminToken }),
            });
            
            if (verifyRes.ok) {
              const verifyData = await verifyRes.json();
              if (verifyData.valid) {
                // Admin token is valid, allow access
                authCheck.classList.remove('hidden');
                loginRedirect.classList.add('hidden');
                return;
              }
            }
          } catch (err) {
            // Verification failed, continue to login
          }
        }
        
        // No valid token, redirect to login with redirect parameter
        window.location.href = '/login?redirect=/';
      } else {
        // Privacy config check failed, allow access (fail open)
        authCheck.classList.remove('hidden');
        loginRedirect.classList.add('hidden');
      }
    } catch (err) {
      // Privacy config check failed, allow access (fail open)
      authCheck.classList.remove('hidden');
      loginRedirect.classList.add('hidden');
    }
  })();
</script>

